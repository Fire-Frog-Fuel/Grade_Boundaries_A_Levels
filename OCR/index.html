<!DOCTYPE html>
<html lang="en">
  <head>
    <script defer data-domain="gradeboundaries.com" src="https://plausible.io/js/script.js"></script>
    <script data-goatcounter="https://gradeboundaries13.goatcounter.com/count"
        async src="//gc.zgo.at/count.js"></script>
    <!-- Google tag (gtag.js) -->

    <base href="/Grade_Boundaries_A_Levels/">
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>OCR Grade Boundaries</title>
    <!-- ‚îÄ‚îÄ‚îÄ PERFORMANCE HINTS ‚îÄ‚îÄ‚îÄ -->
    <link rel="preconnect" href="https://cdn.jsdelivr.net" />
    <link rel="preconnect" href="https://cdn.datatables.net" />
    <link rel="preconnect" href="https://code.jquery.com" />
    <script>
      /*‚ÄÉInstant-load theme so there‚Äôs zero flash of wrong colour‚ÄÉ*/
      (() => {
        const saved = localStorage.getItem('theme');
        if (
          saved === 'dark' ||
          (!saved && matchMedia('(prefers-color-scheme: dark)').matches)
        ) {
          document.documentElement.classList.add('dark');
        }
      })();
    </script>
    <!-- Tailwind (safe to defer) -->
    <script src="https://cdn.tailwindcss.com" defer></script>
    <link rel="stylesheet" href="style.css" />

    <!-- PapaParse (needed before fetching/parsing CSV) -->
    <script
      src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"
      defer
    ></script>

    <!-- DataTables CSS -->
    <link
      rel="stylesheet"
      href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css"
    />
    <link
      rel="stylesheet"
      href="https://cdn.datatables.net/responsive/2.5.0/css/responsive.dataTables.min.css"
    />
    <!--
    <style>
      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background: linear-gradient(to bottom, #def2f1, #ffffff);
      }
      header {
        background-color: #3aafa9;
      }
      nav a:hover {
        color: #ffffff;
        border-bottom: 2px solid #feffff;
      }
      table.dataTable thead th {
        background-color: #3aafa9;
        color: white;
      }
      table.dataTable tbody tr:hover {
        background-color: #dff6f5;
      }

      /* ‚îÄ‚îÄ‚îÄ MOBILE-FRIENDLY TABLE ‚îÄ‚îÄ‚îÄ */
      .table-wrapper {
        width: 100%;
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
      }
      table.dataTable th,
      table.dataTable td {
        padding: 0.25rem 0.5rem !important;
        line-height: 1.2;
      }
      table.dataTable th {
        font-size: clamp(0.875rem, 2vw, 1.25rem);
        white-space: nowrap;
      }
      table.dataTable td {
        font-size: clamp(0.75rem, 1.2vw, 1rem);
      }
      table.dataTable {
        width: 100%;
        max-width: 1000px;
        margin: 0 auto;
      }
      @media (max-width: 400px) {
        table.dataTable th,
        table.dataTable td {
          padding: 0.125rem 0.25rem !important;
        }
      }

      /* ‚îÄ‚îÄ‚îÄ RESPONSIVE CHART ‚îÄ‚îÄ‚îÄ */
      .chart-container {
        position: relative;
        width: 100%;
        /* Even taller graph */
        min-height: 450px;
        height: 70vw; /* scales with screen width on mobiles */
        max-height: 800px; /* avoids being massive on desktops */
      }
      .chart-container canvas {
        position: absolute;
        inset: 0;
        width: 100% !important;
        height: 100% !important;
      }
    </style> -->
  </head>

  <body class="text-gray-800 flex flex-col min-h-screen">
    <header class="text-white text-center py-6 shadow-lg">
      <h1 class="page-title">OCR Grade Boundaries</h1>
      <button id="theme-toggle" class="absolute top-4 right-4">üåô</button>
      <nav class="mt-4 flex flex-col md:flex-row items-center justify-center gap-2">
        <a href="" class="nav-link mx-4 text-base sm:text-lg hover:text-white transition"
          >Home</a
        >
        <a href="CIE" class="nav-link mx-4 text-base sm:text-lg hover:text-white transition"
          >CIE</a
        >
        <a href="Edexcel" class="nav-link mx-4 text-base sm:text-lg hover:text-white transition"
          >Edexcel</a
        >
        <a
          href="OxfordAqa"
          class="nav-link mx-4 text-base sm:text-lg hover:text-white transition"
          >Oxford&nbsp;AQA</a
        >
      </nav>
    </header>

    <main class="flex-1 w-full px-4">
      <section
        class="bg-white rounded-lg shadow-md p-6 w-full max-w-7xl mx-auto"
      >
        <h2 class="text-2xl font-semibold mb-4">OCR Grade Boundaries</h2>

        <!-- ===== TABLE ===== -->
        <div class="table-wrapper mb-6">
          <table
            id="OCRTable"
            class="display nowrap responsive w-full"
            aria-describedby="grade-boundaries-caption"
          >
            <caption
              id="grade-boundaries-caption"
              class="sr-only"
            >
              OCR grade boundaries per year / session / component / unit
            </caption>
            <thead>
              <tr></tr>
            </thead>
          </table>
        </div>

        <!-- ===== CSV DOWNLOAD ===== -->
        <div class="text-right my-4">
          <button
            id="downloadCSV"
            class="class-button px-4 py-2 rounded hover:bg-[#2b7a78] transition"
          >
            Download CSV
          </button>
        </div>

        <!-- ===== CONTROLS ===== -->
        <div
          id="ocr-controls"
          class="flex flex-wrap gap-4 mb-6 items-center"
        >
          <label for="ocrCodeSearch" class="font-semibold">Code:</label>
          <input
            type="text"
            id="ocrCodeSearch"
            placeholder="e.g. H407"
            class="border rounded px-2 py-1 w-24 sm:w-auto"
            list="ocrCodeList"
          />
          <datalist id="ocrCodeList"></datalist>

          <label for="ocrComponentSearch" class="font-semibold"
            >Component&nbsp;(for&nbsp;graph):</label
          >
          <input
            type="text"
            id="ocrComponentSearch"
            placeholder="select component"
            class="border rounded px-2 py-1 w-24 sm:w-32"
            list="ocrComponentList"
            disabled
          />
          <datalist id="ocrComponentList"></datalist>
        </div>

        <!-- ===== CHART ===== -->
        <div class="chart-container">
          <canvas id="OCRChart"></canvas>
        </div>
      </section>
    </main>

    <footer class="text-white text-center py-4 mt-10">
      <p>
        Database provided by
        <a
          href="https://github.com/ChessMastermind"
          class="underline hover:text-gray-200"
          >ChessMastermind</a
        >
      </p>
      <p><a href="Privacy" class="underline hover:text-gray-200">Privacy</a></p>
    </footer>

    <!-- ‚îÄ‚îÄ‚îÄ PAGE SCRIPT ‚îÄ‚îÄ‚îÄ -->
    <script defer>
      // Helper to load external scripts dynamically
      const loadScript = (src) =>
        new Promise((resolve) => {
          const s = document.createElement('script');
          s.src = src;
          s.onload = resolve;
          document.body.appendChild(s);
        });

      window.addEventListener('DOMContentLoaded', () => {
        fetch('OCR/OCR.csv')
          .then((r) => r.text())
          .then(
            (csvText) =>
              new Promise((resolve) => {
                Papa.parse(csvText, {
                  header: true,
                  dynamicTyping: true,
                  skipEmptyLines: true,
                  worker: true,
                  complete: ({ data }) => resolve([data, csvText]),
                });
              })
          )
          .then(async ([parsed, csvText]) => {
            await loadScript('https://code.jquery.com/jquery-3.6.0.min.js');
            await Promise.all([
              loadScript(
                'https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js'
              ),
              loadScript(
                'https://cdn.datatables.net/responsive/2.5.0/js/dataTables.responsive.min.js'
              ),
              loadScript('https://cdn.jsdelivr.net/npm/chart.js'),
            ]);
            initPage(parsed, csvText);
          })
          .catch((err) => {
            console.error(err);
            document.getElementById('OCRTable').innerHTML =
              '<tbody><tr><td colspan="12" class="text-center py-4">Failed to load data.</td></tr></tbody>';
          });
      });

      function initPage(parsed, csvText) {
        const tableEl = $('#OCRTable');

        // Build DataTable columns from CSV headers
        const headers = Object.keys(parsed[0] || {});
        const dtColumns = headers.map((h) => ({ data: h, title: h }));

        // Initialize DataTable
        const dataTable = tableEl.DataTable({
          data: parsed,
          columns: dtColumns,
          responsive: true,
          autoWidth: false,
          deferRender: true,
          pageLength: 10,
        });

        // Add ‚ÄúComponent‚Äù filter next to the default table filter if a component column exists:
        const compHeaderAliases = [
          'component',
          'Component',
          'ComponentCode',
          'component_code',
        ];
        const componentColIdx = headers.findIndex((h) =>
          compHeaderAliases.includes(h)
        );
        if (componentColIdx !== -1) {
          const componentSet = new Set(
            parsed
              .map((row) => row[headers[componentColIdx]])
              .filter(Boolean)
          );
          const filterDiv = $('#OCRTable_filter');
          filterDiv.append(
            `<label style="margin-left:1rem;font-weight:600;">Component:&nbsp;<input type="text" id="componentTableSearch" list="componentTableList" placeholder="component" class="border rounded px-2 py-1 w-24 sm:w-32"></label>`
          );
          $('body').append('<datalist id="componentTableList"></datalist>');
          componentSet.forEach((c) =>
            $('#componentTableList').append(`<option value="${c}"></option>`)
          );
          $('#componentTableSearch').on('input', function () {
            dataTable.column(componentColIdx).search(this.value).draw();
          });
        }

        // Build a nested data structure keyed by [code][component][‚ÄúYYYY MMM‚Äù]
        //
        // Example:
        //   ocrByCodeComp['H407']['11']['2023 June'] = {
        //     'a*': 82, 'a': 71, ‚Ä¶, 'u': 0, max_mark: 98
        //   }
        const ocrByCodeComp = {};
        const gradeList = ['a*', 'a', 'b', 'c', 'd', 'e', 'u'];
        const monthOrder = {
          Jan: 1,
          Feb: 2,
          Mar: 3,
          Apr: 4,
          May: 5,
          Jun: 6,
          Jul: 7,
          Aug: 8,
          Sep: 9,
          Oct: 10,
          Nov: 11,
          Dec: 12,
        };

        parsed.forEach((row) => {
          // Coerce everything to string before trimming, so no .trim() errors
          const yearStr = String(row['year'] || '').trim();
          const sessionStr = String(row['session'] || '').trim();
          const codeStr = String(row['code'] || '').trim();
          const compStr = String(row['component'] || '').trim();
          if (!yearStr || !sessionStr || !codeStr) return;

          // ‚Äú2023 June‚Äù, ‚Äú2024 November‚Äù, etc.
          const sessionKey = `${yearStr} ${sessionStr}`;

          ocrByCodeComp[codeStr] ??= {};
          ocrByCodeComp[codeStr][compStr || 'ALL'] ??= {};
          ocrByCodeComp[codeStr][compStr || 'ALL'][sessionKey] ??= {};

          // Collect each grade boundary
          gradeList.forEach((g) => {
            const val = parseFloat(row[g.toUpperCase()] ?? row[g] ?? '');
            if (!isNaN(val)) {
              ocrByCodeComp[codeStr][compStr || 'ALL'][sessionKey][g] = val;
            }
          });
          // Also record max_mark if present
          const maxMarkVal = parseFloat(row['max_mark'] ?? '');
          if (!isNaN(maxMarkVal)) {
            ocrByCodeComp[codeStr][compStr || 'ALL'][sessionKey]['max_mark'] = maxMarkVal;
          }
        });

        // References to our two inputs and datalists:
        const codeInput = document.getElementById('ocrCodeSearch');
        const componentInput = document.getElementById('ocrComponentSearch');

        const codeList = document.getElementById('ocrCodeList');
        const componentList = document.getElementById('ocrComponentList');

        // Populate the ‚ÄúCode‚Äù datalist with every unique code from the CSV:
        const uniqueCodes = new Set(parsed.map((r) => String(r['code'] || '').trim()).filter(Boolean));
        Array.from(uniqueCodes)
          .sort()
          .forEach((c) => {
            codeList.appendChild(Object.assign(document.createElement('option'), { value: c }));
          });

        // When a code is selected, populate ‚ÄúComponent‚Äù datalist with all components for that code:
        function populateComponentsForCode(code) {
          componentList.innerHTML = '';
          componentInput.value = '';
          componentInput.disabled = true;
          if (!code || !ocrByCodeComp[code]) return;

          // All components (including ‚ÄúALL‚Äù if some rows have no component)
          const comps = Object.keys(ocrByCodeComp[code]).sort();
          if (!comps.length) return;

          componentInput.disabled = false;
          comps.forEach((compVal) => {
            componentList.appendChild(Object.assign(document.createElement('option'), { value: compVal }));
          });
          // Default to the first component in alphabetical order
          componentInput.value = comps[0];
        }

        // Chart setup
        const ctx = document.getElementById('OCRChart').getContext('2d');
        let chart = null;
        const gradeColors = {
          'a*': '#2ECC71',
          a: '#F4A261',
          b: '#E9C46A',
          c: '#E63946',
          d: '#264653',
          e: '#6D597A',
          u: '#999999',
        };
        const maxMarkColor = '#555555';

        function updateChart() {
          const codeVal = codeInput.value.trim();
          const compVal = componentInput.value.trim();
          if (!codeVal || !compVal || !ocrByCodeComp[codeVal] || !ocrByCodeComp[codeVal][compVal]) {
            if (chart) {
              chart.destroy();
              chart = null;
            }
            return;
          }
          const dataObj = ocrByCodeComp[codeVal][compVal];
          const sessions = Object.keys(dataObj);
          if (!sessions.length) {
            if (chart) {
              chart.destroy();
              chart = null;
            }
            return;
          }
          // Sort ‚Äú2023 June‚Äù, ‚Äú2023 November‚Äù, ‚Äú2024 June‚Äù by year, then by month:
          sessions.sort((a, b) => {
            // a = ‚ÄúYYYY MMM‚Äù
            const [ay, am] = a.split('\u00A0'); // split on non-breaking space
            const [by, bm] = b.split('\u00A0');
            const diffYear = +ay - +by;
            if (diffYear !== 0) return diffYear;
            return (monthOrder[am] || 0) - (monthOrder[bm] || 0);
          });

          // Check if any session has an ‚Äúa*‚Äù boundary
          const hasAstar = sessions.some((sess) => 'a*' in dataObj[sess]);
          const gradesToPlot = gradeList.filter((g) => g !== 'a*' || hasAstar);

          // Build a dataset for each grade letter
          const datasets = gradesToPlot.map((g) => ({
            label: g.toUpperCase(),
            data: sessions.map((sess) => dataObj[sess][g] ?? null),
            borderColor: gradeColors[g],
            tension: 0.2,
            fill: false,
          }));
          // Add ‚ÄúMax mark‚Äù as a dashed line
          datasets.push({
            label: 'Max mark',
            data: sessions.map((sess) => dataObj[sess]['max_mark'] ?? null),
            borderColor: maxMarkColor,
            borderDash: [5, 5],
            borderWidth: 1,
            pointRadius: 0,
            fill: false,
          });

          if (chart) chart.destroy();
          chart = new Chart(ctx, {
            type: 'line',
            data: {
              labels: sessions,
              datasets,
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: {
                title: {
                  display: true,
                  text: `Grade Boundaries ‚Äî ${codeVal} (${compVal})`,
                },
                legend: { position: 'bottom' },
              },
              scales: {
                x: { title: { display: true, text: 'Exam Session (Year Month)' } },
                y: { beginAtZero: true, title: { display: true, text: 'Marks' } },
              },
            },
          });
        }

        // Event listeners:
        codeInput.addEventListener('input', () => {
          populateComponentsForCode(codeInput.value.trim());
          updateChart();
        });
        componentInput.addEventListener('input', updateChart);

        // Initialize with the first available code & component
        const firstCode = Array.from(uniqueCodes).sort()[0] || '';
        codeInput.value = firstCode;
        populateComponentsForCode(firstCode);
        updateChart();

        // CSV download
        document.getElementById('downloadCSV').addEventListener('click', () => {
          const blob = new Blob([csvText], { type: 'text/csv' });
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = 'OCR.csv';
          a.click();
          URL.revokeObjectURL(url);
        });
      }
    </script>
    <!-- üü¢ put this at the BOTTOM of <body> -->

    <script>
      const btn = document.getElementById('theme-toggle');
      const root = document.documentElement;

      /*  swap icon to match current state  */
      btn.textContent = root.classList.contains('dark') ? '‚òÄÔ∏è' : 'üåô';

      btn.addEventListener('click', () => {
        const dark = root.classList.toggle('dark');
        localStorage.setItem('theme', dark ? 'dark' : 'light');
        btn.textContent = dark ? '‚òÄÔ∏è' : 'üåô';
      });
    </script>
  </body>
</html>
