<!DOCTYPE html><html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>CIE Grade Boundaries</title><!-- ‚îÄ‚îÄ‚îÄ PERFORMANCE HINTS ‚îÄ‚îÄ‚îÄ -->
<link rel="preconnect" href="https://cdn.jsdelivr.net" />
<link rel="preconnect" href="https://cdn.datatables.net" />
<link rel="preconnect" href="https://code.jquery.com" />
<script>
/*‚ÄÉInstant-load theme so there‚Äôs zero flash of wrong colour‚ÄÉ*/
(() => {
  const saved = localStorage.getItem('theme');
  if (saved === 'dark' ||
      (!saved && matchMedia('(prefers-color-scheme: dark)').matches)) {
    document.documentElement.classList.add('dark');
  }
})();
</script>
<!-- Tailwind (small ‚Äì safe to defer) -->
<script src="https://cdn.tailwindcss.com" defer></script>
<link rel="stylesheet" href="style.css">
    
<!-- PapaParse (needed before fetching/parsing CSV) -->
<script
  src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"
  defer
></script>

<!-- DataTables CSS -->
<link
  rel="stylesheet"
  href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css"
/>
<link
  rel="stylesheet"
  href="https://cdn.datatables.net/responsive/2.5.0/css/responsive.dataTables.min.css"
/>

<style>
  body {
    font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
    background: linear-gradient(to bottom, #def2f1, #ffffff);
  }
  header {
    background-color: #3aafa9;
  }
  nav a:hover {
    color: #ffffff;
    border-bottom: 2px solid #feffff;
  }
  table.dataTable thead th {
    background-color: #3aafa9;
    color: white;
  }
  table.dataTable tbody tr:hover {
    background-color: #dff6f5;
  }

  /* ‚îÄ‚îÄ‚îÄ MOBILE-FRIENDLY TABLE ‚îÄ‚îÄ‚îÄ */
  .table-wrapper {
    width: 100%;
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
  }
  table.dataTable th,
  table.dataTable td {
    padding: 0.25rem 0.5rem !important;
    line-height: 1.2;
  }
  table.dataTable th {
    font-size: clamp(0.875rem, 2vw, 1.25rem);
    white-space: nowrap;
  }
  table.dataTable td {
    font-size: clamp(0.75rem, 1.2vw, 1rem);
  }
  table.dataTable {
    width: 100%;
    max-width: 1000px;
    margin: 0 auto;
  }
  @media (max-width: 400px) {
    table.dataTable th,
    table.dataTable td {
      padding: 0.125rem 0.25rem !important;
    }
  }

  /* ‚îÄ‚îÄ‚îÄ RESPONSIVE CHART ‚îÄ‚îÄ‚îÄ */
  .chart-container {
    position: relative;
    width: 100%;
    /* Even taller graph */
    min-height: 450px;
    height: 70vw; /* scales with screen width on mobiles */
    max-height: 800px; /* avoids being massive on desktops */
  }
  .chart-container canvas {
    position: absolute;
    inset: 0;
    width: 100% !important;
    height: 100% !important;
  }
</style>

  </head>  <body class="text-gray-800 flex flex-col min-h-screen">
    <header class="text-white text-center py-6 shadow-lg">
      <h1 class="text-3xl sm:text-4xl font-bold">
        Cambridge International Grade Boundaries
      </h1>
      <nav class="mt-4">
        <a href="index.html" class="mx-4 text-base sm:text-lg hover:text-white transition">Home</a>
        <a href="Edexcel.html" class="mx-4 text-base sm:text-lg hover:text-white transition">Edexcel</a>
        <a href="OxfordAqa.html" class="mx-4 text-base sm:text-lg hover:text-white transition">Oxford&nbsp;AQA</a>
      </nav>
    </header><main class="flex-1 w-full px-4">
  <section class="bg-white rounded-lg shadow-md p-6 w-full max-w-6xl mx-auto">
    <h2 class="text-2xl font-semibold mb-4">Cambridge International Grade Boundaries</h2>

    <!-- ===== TABLE ===== -->
    <div class="table-wrapper mb-6">
      <table id="CIETable" class="display nowrap responsive w-full" aria-describedby="grade-boundaries-caption">
        <caption id="grade-boundaries-caption" class="sr-only">Cambridge grade boundaries per unit / component code</caption>
        <thead>
          <tr></tr>
        </thead>
      </table>
    </div>

    <!-- ===== CSV DOWNLOAD ===== -->
    <div class="text-right my-4">
      <button id="downloadCSV" class="bg-[#3aafa9] text-white px-4 py-2 rounded hover:bg-[#2b7a78] transition">Download CSV</button>
    </div>

    <!-- ===== CONTROLS ===== -->
    <div id="cie-controls" class="flex flex-wrap gap-4 mb-6 items-center">
      <label for="cieSubjectSearch" class="font-semibold">Subject&nbsp;Code:</label>
      <input type="text" id="cieSubjectSearch" placeholder="e.g. 9709" class="border rounded px-2 py-1 w-32 sm:w-auto" list="cieSubjectList" />
      <datalist id="cieSubjectList"></datalist>

      <label for="cieComponentSearch" class="font-semibold">Component&nbsp;(for&nbsp;graph):</label>
      <input type="text" id="cieComponentSearch" placeholder="select component" class="border rounded px-2 py-1 w-24 sm:w-32" list="cieComponentList" disabled />
      <datalist id="cieComponentList"></datalist>
    </div>

    <!-- ===== CHART ===== -->
    <div class="chart-container">
      <canvas id="CIEChart"></canvas>
    </div>
  </section>
</main>

<footer class="bg-[#3aafa9] text-white text-center py-4 mt-10">
  <p>Database provided by <a href="https://github.com/ChessMastermind" class="underline hover:text-gray-200">ChessMastermind</a></p>
</footer>

<!-- ‚îÄ‚îÄ‚îÄ PAGE SCRIPT ‚îÄ‚îÄ‚îÄ -->
<script defer>
  // Helper to load external scripts dynamically
  const loadScript = (src) => new Promise((resolve) => {
    const s = document.createElement('script');
    s.src = src;
    s.onload = resolve;
    document.body.appendChild(s);
  });

  window.addEventListener('DOMContentLoaded', () => {
    fetch('CIE.csv')
      .then((r) => r.text())
      .then((csvText) => new Promise((resolve) => {
        Papa.parse(csvText, {
          header: true,
          dynamicTyping: true,
          skipEmptyLines: true,
          worker: true,
          complete: ({ data }) => resolve([data, csvText])
        });
      }))
      .then(async ([parsed, csvText]) => {
        await loadScript('https://code.jquery.com/jquery-3.6.0.min.js');
        await Promise.all([
          loadScript('https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js'),
          loadScript('https://cdn.datatables.net/responsive/2.5.0/js/dataTables.responsive.min.js'),
          loadScript('https://cdn.jsdelivr.net/npm/chart.js')
        ]);
        initPage(parsed, csvText);
      })
      .catch((err) => {
        console.error(err);
        document.getElementById('CIETable').innerHTML = '<tbody><tr><td colspan="10" class="text-center py-4">Failed to load data.</td></tr></tbody>';
      });
  });

  function initPage(parsed, csvText) {
    const tableEl = $('#CIETable');

    // Build columns from headers
    const headers = Object.keys(parsed[0] || {});
    const dtColumns = headers.map((h) => ({ data: h, title: h }));

    // DataTable initialisation
    const dataTable = tableEl.DataTable({
      data: parsed,
      columns: dtColumns,
      responsive: true,
      autoWidth: false,
      deferRender: true,
      pageLength: 10
    });

    // Optional component filter in table search
    const compHeaderAliases = ['Component', 'component', 'ComponentCode', 'component_code'];
    const componentColIdx = headers.findIndex((h) => compHeaderAliases.includes(h));
    if (componentColIdx !== -1) {
      // gather unique comps
      const componentSet = new Set(parsed.map((row) => row[headers[componentColIdx]]).filter(Boolean));
      // append UI next to default filter
      const filterDiv = $('#CIETable_filter');
      filterDiv.append(`<label style="margin-left:1rem;font-weight:600;">Component:&nbsp;<input type="text" id="componentTableSearch" list="componentTableList" placeholder="component" class="border rounded px-2 py-1 w-24 sm:w-32"></label>`);
      $('body').append('<datalist id="componentTableList"></datalist>');
      componentSet.forEach((c) => $('#componentTableList').append(`<option value="${c}"></option>`));
      $('#componentTableSearch').on('input', function () {
        dataTable.column(componentColIdx).search(this.value).draw();
      });
    }

    // Structure for chart
    const cieDataBySubject = {};
    const gradeList = ['a*','a','b','c','d','e'];
    const monthOrder = {Jan:1,Feb:2,Mar:3,Apr:4,May:5,Jun:6,Jul:7,Aug:8,Sep:9,Oct:10,Nov:11,Dec:12};

    parsed.forEach((row) => {
      const sessionRaw = row['Series'] || row['session'] || row['Session'] || '';
      const subject = row['SubjectCode'] || row['code'] || row['subject'] || '';
      const component = row['Component'] || row['component'] || row['ComponentCode'] || row['component_code'] || '';
      if (!sessionRaw || !subject) return;

      let session = sessionRaw.trim();
      if (!/^\d{4}\s+[A-Za-z]{3}$/.test(session)) {
        const parts = session.replace('-', ' ').split(/\s+/);
        if (parts.length === 2) session = `${parts[1]} ${parts[0].substring(0,3)}`;
      }

      const compKey = component || 'ALL';
      cieDataBySubject[subject] ??= {};
      cieDataBySubject[subject][compKey] ??= {};

      cieDataBySubject[subject][compKey][session] ??= {};
      gradeList.forEach((g) => {
        const val = parseFloat(row[g.toUpperCase()] ?? row[g] ?? '');
        if (!isNaN(val)) cieDataBySubject[subject][compKey][session][g] = val;
      });
      const maxMark = parseFloat(row['MaxMark'] || row['max_mark'] || '');
      if (!isNaN(maxMark)) cieDataBySubject[subject][compKey][session]['max_mark'] = maxMark;
    });

    // Datalists for chart controls
    const subjectInput = document.getElementById('cieSubjectSearch');
    const componentInput = document.getElementById('cieComponentSearch');
    const subjectList = document.getElementById('cieSubjectList');
    const componentList = document.getElementById('cieComponentList');

    Object.keys(cieDataBySubject).sort().forEach((code) => {
      subjectList.appendChild(Object.assign(document.createElement('option'), { value: code }));
    });

    function populateComponents(subj) {
      componentList.innerHTML = '';
      componentInput.value = '';
      componentInput.disabled = true;
      if (!subj || !cieDataBySubject[subj]) return;
      const comps = Object.keys(cieDataBySubject[subj]).filter((c) => c !== 'ALL');
      if (!comps.length) return;
      componentInput.disabled = false;
      comps.sort().forEach((c) => componentList.appendChild(Object.assign(document.createElement('option'), { value: c })));
      componentInput.value = comps[0];
    }

    // Chart setup
    const ctx = document.getElementById('CIEChart').getContext('2d');
    let chart = null;
    const gradeColors = { 'a*':'#2ECC71', a:'#F4A261', b:'#E9C46A', c:'#E63946', d:'#264653', e:'#6D597A' };
    const maxMarkColor = '#999999';

    function updateChart() {
      const subj = subjectInput.value.trim();
      const comp = componentInput.value.trim();
      if (!subj || !comp || !cieDataBySubject[subj] || !cieDataBySubject[subj][comp]) {
        if (chart) { chart.destroy(); chart = null; }
        return;
      }
      const dataObj = cieDataBySubject[subj][comp];
      const sessions = Object.keys(dataObj);
      if (!sessions.length) { if (chart) { chart.destroy(); chart = null; } return; }
      sessions.sort((a,b) => { const [ya,ma] = a.split(' '); const [yb,mb] = b.split(' '); return (+ya-+yb) || (monthOrder[ma]-monthOrder[mb]); });

      const hasAStar = sessions.some((s) => 'a*' in dataObj[s]);
      const grades = gradeList.filter((g) => g!=='a*' || hasAStar);
      const datasets = grades.map((g) => ({ label: g.toUpperCase(), data: sessions.map((s) => dataObj[s][g] ?? null), borderColor: gradeColors[g], tension:0.2, fill:false }));
      datasets.push({ label:'Max¬†Mark', data:sessions.map((s)=>dataObj[s]['max_mark']??null), borderColor:maxMarkColor, borderDash:[5,5], borderWidth:1, pointRadius:0, fill:false });

      if (chart) chart.destroy();
      chart = new Chart(ctx, {
        type:'line',
        data:{ labels:sessions, datasets },
        options:{
          responsive:true,
          maintainAspectRatio:false,
          plugins:{ title:{ display:true, text:`Grade Boundaries ‚Äî ${subj} (${comp})` }, legend:{ position:'bottom' } },
          scales:{ x:{ title:{ display:true, text:'Exam Session' } }, y:{ beginAtZero:true, title:{ display:true, text:'Marks' } } }
        }
      });
    }

    subjectInput.addEventListener('input', () => { populateComponents(subjectInput.value.trim()); updateChart(); });
    componentInput.addEventListener('input', updateChart);

    // Initialise controls with first subject
    subjectInput.value = Object.keys(cieDataBySubject)[0] || '';
    populateComponents(subjectInput.value);
    updateChart();

    // CSV download
    document.getElementById('downloadCSV').addEventListener('click', () => {
      const blob = new Blob([csvText], { type:'text/csv' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'CIE_Grade_Boundaries.csv';
      a.click();
      URL.revokeObjectURL(url);
    });
  }
</script>
<!-- üü¢ put this at the BOTTOM of <body> -->
<button id="theme-toggle" aria-label="Toggle dark / light mode">üåô</button>

<script>
const btn  = document.getElementById('theme-toggle');
const root = document.documentElement;

/*  swap icon to match current state  */
btn.textContent = root.classList.contains('dark') ? '‚òÄÔ∏è' : 'üåô';

btn.addEventListener('click', () => {
  const dark = root.classList.toggle('dark');
  localStorage.setItem('theme', dark ? 'dark' : 'light');
  btn.textContent = dark ? '‚òÄÔ∏è' : 'üåô';
});
</script>

  </body>
</html>
